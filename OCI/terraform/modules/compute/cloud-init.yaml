#cloud-config
# Cloud-init configuration for PerfAnalysis performance testing VMs
# SIMPLIFIED: Minimal boot config - software installed post-boot via SSH
#
# Lessons learned from 2026-01-07 deployment:
# 1. DNF package operations require 1.5GB+ peak memory
# 2. Cloud-init users: block interferes with opc SSH key provisioning
# 3. Complex cloud-init causes boot failures on constrained instances
#
# Strategy: Boot minimal, install software via SSH after instance is accessible

# Disable package operations during boot to avoid OOM
package_update: false
package_upgrade: false

# IMPORTANT: Do NOT use 'users' block - it prevents opc SSH key provisioning
# The opc user is automatically created by OCI with SSH keys from metadata

# Add swap space for memory buffer during package operations
bootcmd:
  - |
    if [ ! -f /swapfile ]; then
      fallocate -l 2G /swapfile
      chmod 600 /swapfile
      mkswap /swapfile
      swapon /swapfile
      echo '/swapfile none swap sw 0 0' >> /etc/fstab
      echo "Swap space created: 2GB"
    fi

write_files:
  # Marker file to indicate cloud-init phases
  - path: /var/log/cloud-init-perftest.log
    content: |
      PerfTest Cloud-Init Log
      ========================
    permissions: '0644'

  # Go environment setup (for when Go is installed post-boot)
  - path: /etc/profile.d/go.sh
    content: |
      export PATH=$PATH:/usr/local/go/bin
      export GOPATH=/home/pcc/go
      export PATH=$PATH:$GOPATH/bin
    permissions: '0644'

  # PCC environment configuration template
  - path: /tmp/pcc_env_template
    content: |
      # PCC Environment Configuration
      export PCC_MODE=local
      export PCC_DURATION=15m
      export PCC_FREQUENCY=5s
      export PCC_COLLECTION=/home/pcc/collections/pcc_$(date +%Y%m%d_%H%M%S).json
      # For trickle mode to XATbackend:
      # export PCC_MODE=trickle
      # export PCC_APIKEY=your_api_key_here
      # export PCC_SERVER=your_xatbackend_url:port
    permissions: '0644'

  # Benchmark script template (will be copied to pcc home after user creation)
  - path: /tmp/run_benchmark.sh
    content: |
      #!/bin/bash
      # Synchronized benchmark script for OCI VMs
      set -e

      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      RESULTS_DIR=/home/pcc/results/$TIMESTAMP
      mkdir -p $RESULTS_DIR

      echo "Starting benchmark at $TIMESTAMP"

      # Check if pcc is available
      if [ -x /home/pcc/perfcollector2/bin/pcc ]; then
        # Start pcc collection in background
        source /home/pcc/.pcc_env
        export PCC_COLLECTION=$RESULTS_DIR/pcc_collection.json
        /home/pcc/perfcollector2/bin/pcc &
        PCC_PID=$!
        sleep 5
      else
        echo "WARNING: pcc not found, running benchmark without collection"
        PCC_PID=""
      fi

      # Run sysbench CPU test
      echo "Running sysbench CPU test..."
      sysbench cpu --threads=1 --time=300 run > $RESULTS_DIR/sysbench_cpu.log 2>&1

      # Run sysbench memory test
      echo "Running sysbench memory test..."
      sysbench memory --threads=1 --time=300 run > $RESULTS_DIR/sysbench_memory.log 2>&1

      # Stop pcc if running
      if [ -n "$PCC_PID" ]; then
        kill $PCC_PID 2>/dev/null || true
        wait $PCC_PID 2>/dev/null || true

        # Process collection to CSV if pcprocess is available
        if [ -x /home/pcc/perfcollector2/bin/pcprocess ]; then
          /home/pcc/perfcollector2/bin/pcprocess -collection $RESULTS_DIR/pcc_collection.json -outdir $RESULTS_DIR/
        fi
      fi

      echo "Benchmark complete. Results in $RESULTS_DIR"
    permissions: '0755'

runcmd:
  # Log start time
  - echo "$(date): Cloud-init runcmd started" >> /var/log/cloud-init-perftest.log

  # Verify swap is active
  - echo "$(date): Swap status - $(swapon --show)" >> /var/log/cloud-init-perftest.log

  # Create pcc user (in runcmd to avoid interfering with opc SSH keys)
  - useradd -m -G wheel -s /bin/bash pcc || true
  - echo 'pcc ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/pcc
  - chmod 440 /etc/sudoers.d/pcc

  # Setup pcc user's SSH access (copy opc's keys)
  - mkdir -p /home/pcc/.ssh
  - cp /home/opc/.ssh/authorized_keys /home/pcc/.ssh/authorized_keys 2>/dev/null || true
  - chmod 700 /home/pcc/.ssh
  - chmod 600 /home/pcc/.ssh/authorized_keys 2>/dev/null || true

  # Copy config templates to pcc home
  - cp /tmp/pcc_env_template /home/pcc/.pcc_env
  - cp /tmp/run_benchmark.sh /home/pcc/run_benchmark.sh
  - mkdir -p /home/pcc/collections /home/pcc/results

  # Fix ownership
  - chown -R pcc:pcc /home/pcc

  # Log completion - DO NOT install packages during cloud-init
  - echo "$(date): Cloud-init runcmd complete - ready for post-boot setup" >> /var/log/cloud-init-perftest.log

final_message: |
  =======================================================
  PerfTest VM boot complete after $UPTIME seconds.

  NEXT STEPS (run via SSH):
  1. SSH to instance as opc user
  2. Run: sudo dnf install -y sysbench
  3. Optionally install Go and perfcollector2
  4. Run benchmarks: sudo -u pcc /home/pcc/run_benchmark.sh

  Check /var/log/cloud-init-perftest.log for boot details.
  =======================================================
